<!DOCTYPE html>
<html>
<head>
    {{template "shared_head"}}
    <title>/jank/{{.Thread.Title}}</title>
    <style>
        {{template "shared_styles"}}
        .container {
            max-width: 800px;
        }
        .thread-title {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: var(--color-text-strong);
        }
        .thread-meta {
            color: var(--color-text-muted);
            margin-bottom: 20px;
        }
        .thread-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        .thread-tag {
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--color-tag-bg);
            color: var(--color-tag-text);
            font-size: 0.75em;
            letter-spacing: 0.02em;
            text-transform: lowercase;
        }
        .posts {
            list-style-type: none;
            padding: 0;
        }
        .post {
            border-bottom: 1px solid var(--color-border-strong);
            padding: 15px 0;
        }
        .post:last-child {
            border-bottom: none;
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }
        .post-author {
            font-weight: bold;
            color: var(--color-text-strong);
        }
        .post-op-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(60, 245, 177, 0.5);
            color: var(--color-link);
            font-size: 0.7em;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .post-op .post-author {
            color: var(--color-link);
        }
        .post-date {
            color: var(--color-text-muted);
            font-size: 0.9em;
        }
        .post-content {
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .post-deleted {
            background: var(--color-surface-alt);
            border-left: 3px solid var(--color-danger);
            padding-left: 12px;
        }
        .post-deleted-message {
            font-style: italic;
            color: var(--color-text-muted);
        }
        .post-deleted-note {
            margin-top: 6px;
            font-size: 0.9em;
            color: var(--color-text-muted);
        }
        .post-number {
            font-size: 0.9em;
            color: var(--color-text-muted);
        }
        .post-links {
            margin-top: 6px;
            font-size: 0.9em;
            color: var(--color-text-muted);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .post-anchor {
            color: var(--color-link);
            font-weight: 600;
            text-decoration: none;
        }
        .post-anchor:hover {
            text-decoration: underline;
        }
        .post-quote {
            color: var(--color-link);
            text-decoration: none;
            font-weight: 600;
        }
        .post-quote:hover {
            text-decoration: underline;
        }
        .post-backlinks {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .post-actions {
            margin-top: 10px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .post-actions details {
            border: 1px solid var(--color-border-soft);
            border-radius: 6px;
            padding: 6px 10px;
            background: var(--color-surface-muted);
        }
        .post-actions summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-text-strong);
        }
        .post-actions form {
            margin-top: 8px;
        }
        .post-actions textarea,
        .post-actions select,
        .post-actions input[type="text"] {
            width: 100%;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .post-actions button {
            background: var(--color-primary);
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .post-actions button:hover {
            background: var(--color-primary-hover);
        }
        .post-actions .danger button {
            background: var(--color-danger);
        }
        .post-backlinks-label {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.7em;
            color: var(--color-text-muted);
        }
        .post-backlinks a {
            color: var(--color-link);
            text-decoration: none;
            font-weight: 600;
        }
        .post-backlinks a:hover {
            text-decoration: underline;
        }
        .post-flair {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 0.85em;
            flex-wrap: wrap;
        }
        .post-flair-label {
            text-transform: uppercase;
            letter-spacing: 0.16em;
            font-size: 0.7em;
            color: var(--color-text-muted);
        }
        .post-flair-badge {
            padding: 3px 10px;
            border-radius: 999px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #1f2a44;
            background: linear-gradient(120deg, #f8f9fb, #e9ecef);
            box-shadow: 0 6px 14px rgba(31, 42, 68, 0.12), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            background-size: 160% 160%;
            animation: flair-shift 7s ease infinite;
        }
        .post-flair[data-flair="uno"] .post-flair-badge {
            color: #2d1b3a;
            background: linear-gradient(120deg, #f7d1ff, #d7f0ff, #fff4c5);
            box-shadow: 0 8px 18px rgba(120, 88, 166, 0.22), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }
        .post-flair[data-flair="dubs"] .post-flair-badge {
            color: #0f2b2d;
            background: linear-gradient(120deg, #d3fff5, #b9ddff, #e9f7ff);
            box-shadow: 0 8px 18px rgba(20, 120, 140, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }
        .post-flair[data-flair="trips"] .post-flair-badge {
            color: #2b1d12;
            background: linear-gradient(120deg, #ffe4b5, #ffd6a5, #fff2cc);
            box-shadow: 0 8px 18px rgba(180, 120, 40, 0.22), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }
        .post-flair[data-flair="quads"] .post-flair-badge {
            color: #1a2b1f;
            background: linear-gradient(120deg, #d6ffd1, #c1f1d8, #f0ffea);
            box-shadow: 0 8px 18px rgba(60, 140, 90, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }
        .post-flair[data-flair="pents"] .post-flair-badge {
            color: #2a1530;
            background: linear-gradient(120deg, #fbd1ff, #f5c3d8, #f7d5ff);
            box-shadow: 0 8px 18px rgba(150, 60, 140, 0.24), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }
        .post-flair[data-flair="default"] .post-flair-badge {
            color: #2f2f2f;
            background: linear-gradient(120deg, #f1f3f5, #e3e7eb);
            box-shadow: 0 6px 14px rgba(40, 40, 40, 0.12), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }
        :root[data-theme="dark"] .post-flair .post-flair-badge {
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.45), inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        }
        :root[data-theme="dark"] .post-flair[data-flair="uno"] .post-flair-badge {
            color: #ffd9ff;
            background: linear-gradient(120deg, #5b14d6, #1b6bff, #ff9b2f);
        }
        :root[data-theme="dark"] .post-flair[data-flair="dubs"] .post-flair-badge {
            color: #c6feff;
            background: linear-gradient(120deg, #00c2b3, #007bff, #12f3ff);
        }
        :root[data-theme="dark"] .post-flair[data-flair="trips"] .post-flair-badge {
            color: #ffe6ad;
            background: linear-gradient(120deg, #ff6a00, #ff2f6f, #ffd400);
        }
        :root[data-theme="dark"] .post-flair[data-flair="quads"] .post-flair-badge {
            color: #c9ffe1;
            background: linear-gradient(120deg, #17f07e, #00c4ff, #7bff33);
        }
        :root[data-theme="dark"] .post-flair[data-flair="pents"] .post-flair-badge {
            color: #ffd0ff;
            background: linear-gradient(120deg, #ff2df7, #a42bff, #ff5fa2);
        }
        :root[data-theme="dark"] .post-flair[data-flair="default"] .post-flair-badge {
            color: #e9f6ff;
            background: linear-gradient(120deg, #1a2a3f, #23486f);
        }
        @keyframes flair-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .card-trees {
            margin: 20px 0 10px;
        }
        .card-tree {
            border: 1px solid var(--color-border-soft);
            border-radius: 6px;
            padding: 12px 14px;
            margin-bottom: 16px;
            background: var(--color-card-bg);
        }
        .card-tree-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }
        .card-tree-title {
            font-weight: 600;
            color: var(--color-text-strong);
        }
        .card-tree-badge {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            background: var(--color-accent-soft-bg);
            color: var(--color-accent-soft-text);
            border-radius: 10px;
            padding: 2px 8px;
        }
        .card-tree-desc {
            color: var(--color-text-muted);
            margin-bottom: 8px;
        }
        .card-tree-nodes {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .card-tree-node {
            position: relative;
            margin-bottom: 10px;
            padding-left: calc(var(--tree-depth) * 18px + 24px);
        }
        .card-tree-node::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: calc(var(--tree-depth) * 18px);
            background-image: repeating-linear-gradient(
                to right,
                transparent 0,
                transparent 14px,
                var(--color-tree-line) 14px,
                var(--color-tree-line) 15px
            );
        }
        .card-tree-connector {
            position: absolute;
            left: calc(var(--tree-depth) * 18px);
            top: 12px;
            width: 16px;
            height: 12px;
            pointer-events: none;
        }
        .card-tree-connector::before {
            content: "";
            position: absolute;
            left: 0;
            top: 5px;
            width: 12px;
            border-top: 2px solid var(--color-tree-line);
        }
        .card-tree-connector::after {
            content: "";
            position: absolute;
            left: 10px;
            top: 2px;
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 6px solid var(--color-tree-line);
        }
        .card-tree-card {
            font-weight: 600;
        }
        .card-tree-annotations {
            list-style-type: none;
            padding-left: 0;
            margin: 4px 0 0 0;
        }
        .card-tree-annotation {
            color: var(--color-text);
            font-size: 0.95em;
            margin-top: 2px;
        }
        .card-tree-annotation-kind {
            text-transform: uppercase;
            font-size: 0.7em;
            letter-spacing: 0.04em;
            color: var(--color-text-muted);
            margin-right: 6px;
        }
        .card-tree-annotation-label {
            font-weight: 600;
            margin-right: 6px;
        }
        .card-tree-annotation-tags {
            color: var(--color-text-muted);
            margin-right: 6px;
        }
        .new-post-form {
            margin-top: 30px;
        }
        .bump-notice {
            border-radius: 10px;
            padding: 10px 12px;
            margin: 10px 0;
            font-size: 0.95em;
            background: var(--color-surface-muted);
            color: var(--color-text);
            border: 1px solid var(--color-border-soft);
        }
        .bump-notice strong {
            color: var(--color-text-strong);
        }
        .bump-notice.bump-necro {
            background: rgba(217, 83, 79, 0.08);
            border-color: rgba(217, 83, 79, 0.2);
        }
        .bump-notice.bump-cooldown {
            background: rgba(0, 123, 255, 0.08);
            border-color: rgba(0, 123, 255, 0.2);
        }
        .new-post-form h2 {
            margin-bottom: 10px;
            color: var(--color-text-strong);
        }
        .new-post-form button {
            padding: 10px 20px;
            background-color: var(--color-success);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .new-post-form button:hover {
            background-color: var(--color-success-hover);
        }
        .fast-reply-trigger {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 30;
            padding: 10px 16px;
            border-radius: 999px;
            border: none;
            background: var(--color-primary);
            color: #fff;
            font-weight: 600;
            letter-spacing: 0.02em;
            box-shadow: 0 12px 30px rgba(20, 30, 50, 0.25);
            cursor: pointer;
        }
        .fast-reply-panel {
            position: fixed;
            right: 24px;
            bottom: 24px;
            width: min(420px, 90vw);
            background: var(--color-card-bg);
            border: 1px solid var(--color-border-strong);
            border-radius: 18px;
            box-shadow: 0 18px 40px rgba(20, 30, 50, 0.25);
            transform: translateY(140%);
            transition: transform 0.3s ease;
            z-index: 40;
            padding: 16px 16px 14px;
            max-height: min(70vh, 560px);
            overflow: auto;
        }
        .fast-reply-panel.is-open {
            transform: translateY(0);
        }
        .fast-reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .fast-reply-title {
            font-weight: 700;
            color: var(--color-text-strong);
        }
        .fast-reply-close {
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            font-size: 1.2em;
            cursor: pointer;
        }
        .fast-reply-body {
            display: grid;
            gap: 10px;
        }
        .fast-reply-body textarea {
            width: 100%;
            resize: vertical;
            min-height: 120px;
        }
        .fast-reply-preview {
            border-radius: 12px;
            border: 1px solid var(--color-border-soft);
            background: var(--color-surface-alt);
            padding: 10px 12px;
            min-height: 120px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .fast-reply-preview blockquote {
            margin: 0 0 8px;
            padding-left: 12px;
            border-left: 3px solid var(--color-border-strong);
            color: var(--color-text-muted);
        }
        .fast-reply-meta {
            color: var(--color-text-muted);
            font-size: 0.85em;
        }
        .fast-reply-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }
        .fast-reply-actions button {
            padding: 8px 16px;
            background-color: var(--color-success);
            color: #fff;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
        }
        .fast-reply-actions button:hover {
            background-color: var(--color-success-hover);
        }
        footer {
            margin-top: 40px;
        }
        @media (max-width: 600px) {
            .post-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .post-date {
                margin-top: 5px;
            }
            .card-tree-node {
                padding-left: calc(var(--tree-depth) * 14px + 22px);
            }
            .card-tree-node::before {
                width: calc(var(--tree-depth) * 14px);
            }
            .card-tree-connector {
                left: calc(var(--tree-depth) * 14px);
            }
            .fast-reply-trigger {
                right: 12px;
                bottom: 12px;
            }
            .fast-reply-panel {
                right: 12px;
                left: 12px;
                width: auto;
                bottom: 12px;
                max-height: 75vh;
            }
        }
    </style>
</head>
<body>
    {{template "site_header" .Thread.Title}}

    <div class="container">
        {{template "auth_bar" .}}
        <div class="thread-title">{{.Thread.Title}} (Thread #{{.Thread.ID}})</div>
        <div class="thread-meta">
            Created on: {{.Thread.Created.Format "Jan 2, 2006 at 3:04pm"}}
            {{if .Thread.Author}} Â· Started by <a href="/user/{{.Thread.Author | urlquery}}">{{.Thread.Author}}</a>{{end}}
            {{if .Thread.Tags}}
                <div class="thread-tags">
                    {{range .Thread.Tags}}
                        <span class="thread-tag">#{{.}}</span>
                    {{end}}
                </div>
            {{end}}
        </div>

        <ul class="posts">
            {{if .Thread.Posts}}
                {{range $index, $post := .Thread.Posts}}
                    <li class="post {{if $post.IsDeleted}}post-deleted{{end}} {{if eq $index 0}}post-op{{end}}" id="post-{{$post.ID}}" data-post-id="{{$post.ID}}">
                        <div class="post-header">
                            <div class="post-author">
                                {{$post.Author}}
                                {{if eq $index 0}}
                                    <span class="post-op-badge">OP</span>
                                {{end}}
                            </div>
                            <div class="post-date">{{$post.Created.Format "Jan 2, 2006 at 3:04pm"}}</div>
                        </div>
                        <div class="post-content" data-deleted="{{$post.IsDeleted}}">{{- if $post.IsDeleted -}}
                                <div class="post-deleted-message">Post removed by moderation.</div>
                                {{- if $post.DeletedReason -}}
                                    <div class="post-deleted-note">Reason: {{$post.DeletedReason}}</div>
                                {{- end -}}
                                {{- if $post.DeletedAt -}}
                                    <div class="post-deleted-note">Removed on {{$post.DeletedAt.Format "Jan 2, 2006 at 3:04pm"}}{{if $post.DeletedBy}} by {{$post.DeletedBy}}{{end}}.</div>
                                {{- end -}}
                            {{- else -}}
                                {{- $post.Content -}}
                            {{- end -}}</div>
                        {{if $post.IsDeleted}}
                        {{else}}
                            {{if $post.Trees}}
                                <div class="card-trees">
                                    <!-- <h3>Card Trees</h3> -->
                                    {{range $post.Trees}}
                                        <div class="card-tree">
                                            <div class="card-tree-header">
                                                <div class="card-tree-title">{{.Title}}</div>
                                                {{if .IsPrimary}}
                                                    <span class="card-tree-badge">Primary</span>
                                                {{end}}
                                            </div>
                                            {{if .Description}}
                                                <div class="card-tree-desc">{{.Description}}</div>
                                            {{end}}
                                            {{if .Nodes}}
                                                <ul class="card-tree-nodes">
                                                    {{range .Nodes}}
                                                        <li class="card-tree-node" style="--tree-depth: {{.Depth}};">
                                                            <span class="card-tree-connector" aria-hidden="true"></span>
                                                            <div class="card-tree-card">[[ {{.CardName}} ]]</div>
                                                            {{if .Annotations}}
                                                                <ul class="card-tree-annotations">
                                                                    {{range .Annotations}}
                                                                        <li class="card-tree-annotation">
                                                                            <span class="card-tree-annotation-kind">{{.Kind}}</span>
                                                                            {{if .Label}}
                                                                                <span class="card-tree-annotation-label">{{.Label}}</span>
                                                                            {{end}}
                                                                            {{if .Tags}}
                                                                                <span class="card-tree-annotation-tags">{{.Tags}}</span>
                                                                            {{end}}
                                                                            <span class="card-tree-annotation-body">{{.Body}}</span>
                                                                        </li>
                                                                    {{end}}
                                                                </ul>
                                                            {{end}}
                                                        </li>
                                                    {{end}}
                                                </ul>
                                            {{else}}
                                                <div class="muted">No cards yet.</div>
                                            {{end}}
                                        </div>
                                    {{end}}
                                </div>
                            {{end}}
                        {{end}}
                        <div class="post-number">post ID: {{$post.Number}}</div>
                        <div class="post-links">
                            <a class="post-anchor" href="#post-{{$post.ID}}">&gt;&gt;{{$post.ID}}</a>
                            <span class="post-backlinks" data-backlinks-for="{{$post.ID}}"></span>
                        </div>
                        {{if or $.IsAuthenticated $.IsModerator}}
                            <div class="post-actions">
                                {{if and $.IsAuthenticated (not $post.IsDeleted)}}
                                    <details class="post-report">
                                        <summary>Report</summary>
                                        <form method="POST" action="/report/post/{{$post.ID}}">
                                            <label for="report-category-{{$post.ID}}">Category</label>
                                            <select id="report-category-{{$post.ID}}" name="category" required>
                                                <option value="" disabled selected>Pick a category</option>
                                                {{range $.ReportCategories}}
                                                    <option value="{{.}}">{{.}}</option>
                                                {{end}}
                                            </select>
                                            <label for="report-reason-{{$post.ID}}">Details (optional)</label>
                                            <textarea id="report-reason-{{$post.ID}}" name="reason" rows="3" placeholder="Tell us what happened."></textarea>
                                            <button type="submit">Send report</button>
                                        </form>
                                    </details>
                                {{end}}
                                {{if and $.IsModerator (not $post.IsDeleted)}}
                                    <details class="danger">
                                        <summary>Remove</summary>
                                        <form method="POST" action="/mod/posts/{{$post.ID}}/delete">
                                            <input type="hidden" name="next" value="{{$.CurrentPath}}">
                                            <label for="delete-reason-{{$post.ID}}">Removal reason</label>
                                            <input id="delete-reason-{{$post.ID}}" name="reason" type="text" placeholder="Required" required />
                                            <button type="submit">Soft delete</button>
                                        </form>
                                    </details>
                                {{end}}
                            </div>
                        {{end}}
                        <div class="post-flair" data-flair="{{$post.Flair}}" data-number="{{$post.Number}}">
                            <span class="post-flair-label">flair</span>
                            <span class="post-flair-badge">{{$post.Flair}}</span>
                        </div>
                    </li>
                {{end}}
            {{else}}
                <li class="post">
                    <div class="post-content">No posts yet. Be the first to reply!</div>
                    {{if .IsAuthenticated}}
                        <div class="muted"><a href="#reply">Jump to reply</a></div>
                    {{else}}
                        <div class="muted"><a href="/login?next={{.CurrentPath | urlquery}}">Log in to reply</a></div>
                    {{end}}
                </li>
            {{end}}
        </ul>

        {{if .IsAuthenticated}}
            {{if gt .BumpCooldownRemaining 0}}
                <div class="bump-notice bump-cooldown" data-remaining="{{.BumpCooldownRemaining}}">
                    <strong>Slow bump:</strong> this thread was just updated. Consider waiting <span class="bump-countdown"></span> before pushing it again.
                </div>
            {{end}}
            {{if .NecroWarning}}
                <div class="bump-notice bump-necro">
                    <strong>Necro warning:</strong> last bump was {{.LastBump.Format "Jan 2, 2006"}}. Consider starting a fresh thread.
                </div>
            {{end}}
            <div class="new-post-form">
                <h2 id="reply">Reply to this Thread ðŸ’¬</h2>
                <p class="muted">Posting as {{.Username}}</p>
                <form id="reply-form" method="POST" action="/view/thread/{{.Thread.ID}}/post">
                    <label for="content">Your Post:</label>
                    <textarea id="content" name="content" rows="5" placeholder="Enter your message here..." required></textarea>

                    <label>
                        <input type="checkbox" id="tree-toggle" />
                        Add card tree(s) to this reply
                    </label>
                    <div id="tree-builder" class="tree-builder tree-builder-hidden">
                        <p class="muted">Tree title and card name are required.</p>
                        <div class="tree-builder-actions">
                            <button type="button" class="tree-builder-add-tree">Add tree</button>
                        </div>
                        <div class="tree-builder-trees"></div>
                    </div>
                    <input type="hidden" id="tree_payload" name="tree_payload" value="" />

                    <button type="submit">Post Reply</button>
                </form>
            </div>
            <button class="fast-reply-trigger" id="fast-reply-toggle" type="button" aria-expanded="false">
                Fast reply
            </button>
            <div class="fast-reply-panel" id="fast-reply-panel" aria-hidden="true">
                <div class="fast-reply-header">
                    <div class="fast-reply-title">Quick reply</div>
                    <button class="fast-reply-close" type="button" id="fast-reply-close" aria-label="Close fast reply">Ã—</button>
                </div>
                <div class="fast-reply-meta">Supports **bold**, *italic*, `code`, [links](url), and [[Card Name]].</div>
                <form id="fast-reply-form" method="POST" action="/view/thread/{{.Thread.ID}}/post">
                    <div class="fast-reply-body">
                        <textarea id="fast-reply-content" name="content" rows="6" placeholder="Drop a fast reply..." required></textarea>
                        <div class="fast-reply-preview" id="fast-reply-preview">Preview will appear here.</div>
                    </div>
                    <input type="hidden" name="tree_payload" value="" />
                    <div class="fast-reply-actions">
                        <button type="submit">Post</button>
                    </div>
                </form>
            </div>
        {{else}}
            {{if .NecroWarning}}
                <div class="bump-notice bump-necro">
                    <strong>Necro warning:</strong> last bump was {{.LastBump.Format "Jan 2, 2006"}}. Consider starting a fresh thread.
                </div>
            {{end}}
            <p>You must be signed in to reply.</p>
            <p><a href="/login?next={{.CurrentPath | urlquery}}">Log in</a> or <a href="/signup?next={{.CurrentPath | urlquery}}">sign up</a> to post.</p>
        {{end}}

        {{template "footer_board" .}}
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const postContents = document.querySelectorAll('.post-content');
            const threadTitle = document.querySelector('.thread-title');
            const threadMeta = document.querySelector('.thread-meta');
            const treeBlocks = document.querySelectorAll('.card-tree');
            const cardNamePattern = /\[\[([^\]]+)\]\]/g;

            const createCardMarkup = (name) => {
                const safeName = name.trim();
                return `<span class="mtg-card" data-card-name="${safeName}">[[ ${safeName} ]]</span>`;
            };

            const quotePattern = /&gt;&gt;(\d+)/g;
            const rawQuotePattern = />>(\d+)/g;
            const backlinks = new Map();

            const recordBacklink = (fromID, toID) => {
                if (!fromID || !toID) {
                    return;
                }
                if (!backlinks.has(toID)) {
                    backlinks.set(toID, new Set());
                }
                backlinks.get(toID).add(fromID);
            };

            postContents.forEach(content => {
                if (content.dataset.deleted === "true") {
                    return;
                }
                const post = content.closest(".post");
                const postID = post?.dataset.postId;
                const html = content.innerHTML;
                const matches = [...html.matchAll(quotePattern), ...html.matchAll(rawQuotePattern)];
                matches.forEach(match => recordBacklink(postID, match[1]));
                const withQuotes = html
                    .replace(quotePattern, (_, id) => `<a class="post-quote" href="#post-${id}">&gt;&gt;${id}</a>`)
                    .replace(rawQuotePattern, (_, id) => `<a class="post-quote" href="#post-${id}">&gt;&gt;${id}</a>`);
                content.innerHTML = withQuotes.replace(cardNamePattern, (_, name) => createCardMarkup(name));
            });

            if (threadTitle) {
                threadTitle.innerHTML = threadTitle.innerHTML.replace(cardNamePattern, (_, name) => createCardMarkup(name));
            }

            if (threadMeta) {
                threadMeta.innerHTML = threadMeta.innerHTML.replace(cardNamePattern, (_, name) => createCardMarkup(name));
            }

            treeBlocks.forEach(tree => {
                tree.innerHTML = tree.innerHTML.replace(cardNamePattern, (_, name) => createCardMarkup(name));
            });

            document.querySelectorAll(".post-backlinks").forEach(container => {
                const postID = container.dataset.backlinksFor;
                const refs = backlinks.get(postID);
                if (!refs || refs.size === 0) {
                    return;
                }
                const label = document.createElement("span");
                label.className = "post-backlinks-label";
                label.textContent = "Replies";
                container.appendChild(label);
                Array.from(refs).sort((a, b) => Number(a) - Number(b)).forEach(refID => {
                    const link = document.createElement("a");
                    link.href = `#post-${refID}`;
                    link.textContent = `>>${refID}`;
                    container.appendChild(link);
                });
            });

            const cardImageCache = new Map();

            function initCardTooltips() {
                const cards = document.querySelectorAll(".mtg-card");
                cards.forEach(card => {
                    if (card.querySelector(".mtg-card-tooltip")) {
                        return;
                    }
                    const name = card.dataset.cardName || card.textContent.replace(/\[\[|\]\]/g, "").trim();
                    const tooltip = document.createElement("span");
                    tooltip.className = "mtg-card-tooltip";
                    tooltip.innerHTML = `
                        <span class="mtg-card-tooltip-title">${name}</span>
                        <span class="mtg-card-tooltip-loading">Loading art...</span>
                        <img class="mtg-card-tooltip-image is-loading" alt="Card art for ${name}" loading="lazy" />
                    `;
                    card.appendChild(tooltip);

                    const loadArt = async () => {
                        if (tooltip.dataset.loaded === "true") {
                            return;
                        }
                        tooltip.dataset.loaded = "true";
                        const img = tooltip.querySelector(".mtg-card-tooltip-image");
                        const loading = tooltip.querySelector(".mtg-card-tooltip-loading");
                        if (!img || !loading) {
                            return;
                        }
                        const finalizeLoaded = () => {
                            img.classList.remove("is-loading");
                            loading.remove();
                        };
                        if (cardImageCache.has(name)) {
                            img.src = cardImageCache.get(name);
                            img.addEventListener("load", finalizeLoaded, { once: true });
                            img.addEventListener("error", () => {
                                img.classList.remove("is-loading");
                                loading.textContent = "Art unavailable.";
                            }, { once: true });
                            return;
                        }
                        try {
                            const fetchCard = async (url) => {
                                const response = await fetch(url);
                                if (!response.ok) {
                                    return null;
                                }
                                return response.json();
                            };
                            const exactUrl = `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(name)}`;
                            const fuzzyUrl = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`;
                            let data = await fetchCard(exactUrl);
                            if (!data) {
                                data = await fetchCard(fuzzyUrl);
                            }
                            if (!data) {
                                throw new Error("Scryfall lookup failed");
                            }
                            const imageUrl =
                                data.image_uris?.normal ||
                                data.image_uris?.small ||
                                data.card_faces?.[0]?.image_uris?.normal ||
                                data.card_faces?.[0]?.image_uris?.small;
                            if (!imageUrl) {
                                throw new Error("Missing card art");
                            }
                            cardImageCache.set(name, imageUrl);
                            img.src = imageUrl;
                            img.addEventListener("load", finalizeLoaded, { once: true });
                            img.addEventListener("error", () => {
                                img.classList.remove("is-loading");
                                loading.textContent = "Art unavailable.";
                            }, { once: true });
                        } catch (error) {
                            img.classList.remove("is-loading");
                            loading.textContent = "Art unavailable.";
                        }
                    };

                    card.addEventListener("mouseenter", loadArt, { once: true });
                    let pressTimer = null;
                    const clearPressTimer = () => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    };
                    const deactivateOthers = () => {
                        cards.forEach(other => {
                            if (other !== card) {
                                other.classList.remove("is-active");
                            }
                        });
                    };
                    card.addEventListener("touchstart", (event) => {
                        clearPressTimer();
                        pressTimer = window.setTimeout(() => {
                            deactivateOthers();
                            card.classList.add("is-active");
                            loadArt();
                        }, 300);
                        event.stopPropagation();
                    }, { passive: true });
                    card.addEventListener("touchend", clearPressTimer);
                    card.addEventListener("touchmove", clearPressTimer);
                    card.addEventListener("click", (event) => {
                        if (card.classList.contains("is-active")) {
                            card.classList.remove("is-active");
                            event.preventDefault();
                            event.stopPropagation();
                            return;
                        }
                    });
                });
            }

            document.addEventListener("touchstart", (event) => {
                if (!event.target.closest(".mtg-card")) {
                    document.querySelectorAll(".mtg-card.is-active").forEach(card => {
                        card.classList.remove("is-active");
                    });
                }
            }, { passive: true });

            const flairBlocks = document.querySelectorAll(".post");
            flairBlocks.forEach(post => {
                const flair = post.querySelector(".post-flair");
                if (!flair) {
                    return;
                }
                const numberText = post.querySelector(".post-number")?.textContent || "";
                const number = (flair.dataset.number || numberText).replace(/\D/g, "");
                const badge = flair.querySelector(".post-flair-badge");
                if (!number || !badge) {
                    return;
                }

                const hasSameSuffix = (len) => {
                    if (number.length < len) {
                        return false;
                    }
                    const suffix = number.slice(-len);
                    return suffix.split("").every(char => char === suffix[0]);
                };

                let nextFlair = null;
                if (hasSameSuffix(4)) {
                    nextFlair = "quads";
                } else if (hasSameSuffix(3)) {
                    nextFlair = "trips";
                } else if (hasSameSuffix(2)) {
                    nextFlair = "dubs";
                }

                if (nextFlair) {
                    flair.dataset.flair = nextFlair;
                    badge.textContent = nextFlair;
                }
            });

            initCardTooltips();

            function initTreeBuilder(options) {
                const form = document.getElementById(options.formId);
                const toggle = document.getElementById(options.toggleId);
                const builder = document.getElementById(options.builderId);
                const payloadInput = document.getElementById(options.payloadId);
                if (!form || !toggle || !builder || !payloadInput) {
                    return;
                }
                const treesContainer = builder.querySelector(".tree-builder-trees");
                const addTreeButton = builder.querySelector(".tree-builder-add-tree");
                let treeCount = 0;

                function updateParentOptions(tree) {
                    const nodes = Array.from(tree.querySelectorAll(".tree-node"));
                    const options = nodes.map(node => {
                        const id = node.dataset.nodeId;
                        const label = node.querySelector(".tree-node-card").value.trim() || `Node ${id}`;
                        return { id, label };
                    });
                    nodes.forEach(node => {
                        const select = node.querySelector(".tree-node-parent");
                        const current = select.value;
                        select.innerHTML = '<option value="">None (root)</option>';
                        options.forEach(option => {
                            if (option.id === node.dataset.nodeId) {
                                return;
                            }
                            const opt = document.createElement("option");
                            opt.value = option.id;
                            opt.textContent = option.label;
                            select.appendChild(opt);
                        });
                        if (current) {
                            select.value = current;
                        }
                    });
                }

                function addAnnotation(node) {
                    const annotations = node.querySelector(".tree-node-annotations");
                    const annotation = document.createElement("div");
                    annotation.className = "tree-node-annotation";
                    annotation.innerHTML = `
                        <label>Kind</label>
                        <input type="text" class="tree-annotation-kind" value="note" />
                        <label>Label</label>
                        <input type="text" class="tree-annotation-label" />
                        <label>Tags</label>
                        <input type="text" class="tree-annotation-tags" placeholder="comma,separated" />
                        <label>Body</label>
                        <textarea class="tree-annotation-body" rows="2"></textarea>
                        <div class="tree-builder-actions">
                            <button type="button" class="tree-builder-remove-annotation">Remove annotation</button>
                        </div>
                    `;
                    annotation.querySelector(".tree-builder-remove-annotation").addEventListener("click", function() {
                        annotation.remove();
                    });
                    annotations.appendChild(annotation);
                }

                function addNode(tree) {
                    const nodesContainer = tree.querySelector(".tree-nodes");
                    const nextIndex = Number(tree.dataset.nodeCounter || "0") + 1;
                    tree.dataset.nodeCounter = String(nextIndex);
                    const nodeId = String(nextIndex);
                    const node = document.createElement("div");
                    node.className = "tree-node";
                    node.dataset.nodeId = nodeId;
                    node.innerHTML = `
                        <div class="tree-node-header">
                            <div class="tree-node-title">Node ${nodeId}</div>
                            <button type="button" class="tree-builder-remove-node">Remove node</button>
                        </div>
                        <label>Card name</label>
                        <input type="text" class="tree-node-card" />
                        <label>Parent node</label>
                        <select class="tree-node-parent"></select>
                        <label>Position</label>
                        <input type="number" class="tree-node-position" value="0" min="0" />
                        <div class="tree-builder-actions">
                            <button type="button" class="tree-builder-add-annotation">Add annotation</button>
                        </div>
                        <div class="tree-node-annotations"></div>
                    `;
                    node.querySelector(".tree-builder-remove-node").addEventListener("click", function() {
                        node.remove();
                        updateParentOptions(tree);
                    });
                    node.querySelector(".tree-node-card").addEventListener("input", function() {
                        updateParentOptions(tree);
                    });
                    node.querySelector(".tree-builder-add-annotation").addEventListener("click", function() {
                        addAnnotation(node);
                    });
                    nodesContainer.appendChild(node);
                    updateParentOptions(tree);
                }

                function addTree() {
                    treeCount += 1;
                    const tree = document.createElement("div");
                    tree.className = "tree-block";
                    tree.dataset.treeId = String(treeCount);
                    tree.innerHTML = `
                        <div class="tree-block-header">
                            <div class="tree-block-title">Tree ${treeCount}</div>
                            <button type="button" class="tree-builder-remove-tree">Remove tree</button>
                        </div>
                        <label>Title</label>
                        <input type="text" class="tree-title" />
                        <label>Description</label>
                        <textarea class="tree-description" rows="2"></textarea>
                        <label>
                            <input type="checkbox" class="tree-primary" />
                            Primary tree
                        </label>
                        <div class="tree-builder-actions">
                            <button type="button" class="tree-builder-add-node">Add node</button>
                        </div>
                        <div class="tree-nodes"></div>
                    `;
                    tree.querySelector(".tree-builder-remove-tree").addEventListener("click", function() {
                        tree.remove();
                    });
                    tree.querySelector(".tree-builder-add-node").addEventListener("click", function() {
                        addNode(tree);
                    });
                    treesContainer.appendChild(tree);
                }

                function buildPayload() {
                    const trees = [];
                    const treeBlocks = Array.from(treesContainer.querySelectorAll(".tree-block"));
                    for (const tree of treeBlocks) {
                        const title = tree.querySelector(".tree-title").value.trim();
                        if (!title) {
                            return { error: "Each tree needs a title." };
                        }
                        const description = tree.querySelector(".tree-description").value.trim();
                        const isPrimary = tree.querySelector(".tree-primary").checked;
                        const nodes = [];
                        const nodeBlocks = Array.from(tree.querySelectorAll(".tree-node"));
                        for (const node of nodeBlocks) {
                            const cardName = node.querySelector(".tree-node-card").value.trim();
                            if (!cardName) {
                                return { error: "Each node needs a card name." };
                            }
                            const parentValue = node.querySelector(".tree-node-parent").value;
                            const positionValue = node.querySelector(".tree-node-position").value;
                            const position = positionValue === "" ? 0 : Number(positionValue);
                            const annotations = [];
                            const annotationBlocks = Array.from(node.querySelectorAll(".tree-node-annotation"));
                            for (const annotation of annotationBlocks) {
                                const body = annotation.querySelector(".tree-annotation-body").value.trim();
                                if (!body) {
                                    continue;
                                }
                                annotations.push({
                                    kind: annotation.querySelector(".tree-annotation-kind").value.trim(),
                                    label: annotation.querySelector(".tree-annotation-label").value.trim(),
                                    tags: annotation.querySelector(".tree-annotation-tags").value.trim(),
                                    body: body
                                });
                            }
                            nodes.push({
                                temp_id: node.dataset.nodeId,
                                parent_temp_id: parentValue ? parentValue : null,
                                card_name: cardName,
                                position: Number.isNaN(position) ? 0 : position,
                                annotations: annotations
                            });
                        }
                        trees.push({
                            title: title,
                            description: description,
                            is_primary: isPrimary,
                            nodes: nodes
                        });
                    }
                    return { data: { trees: trees } };
                }

                toggle.addEventListener("change", function() {
                    builder.classList.toggle("tree-builder-hidden", !toggle.checked);
                    if (!toggle.checked) {
                        payloadInput.value = "";
                    }
                });
                addTreeButton.addEventListener("click", addTree);
                form.addEventListener("submit", function(event) {
                    if (!toggle.checked) {
                        payloadInput.value = "";
                        return;
                    }
                    const payloadResult = buildPayload();
                    if (payloadResult.error) {
                        event.preventDefault();
                        alert(payloadResult.error);
                        return;
                    }
                    payloadInput.value = JSON.stringify(payloadResult.data);
                });
            }

            initTreeBuilder({
                formId: "reply-form",
                toggleId: "tree-toggle",
                builderId: "tree-builder",
                payloadId: "tree_payload"
            });

            const bumpNotice = document.querySelector(".bump-notice.bump-cooldown");
            if (bumpNotice) {
                const countdown = bumpNotice.querySelector(".bump-countdown");
                const total = Number(bumpNotice.dataset.remaining || "0");
                const formatCountdown = (seconds) => {
                    const minutes = Math.floor(seconds / 60);
                    const remaining = Math.max(0, Math.floor(seconds % 60));
                    if (minutes > 0) {
                        return `${minutes}m ${remaining}s`;
                    }
                    return `${remaining}s`;
                };
                if (countdown && total > 0) {
                    let remaining = total;
                    countdown.textContent = formatCountdown(remaining);
                    const timer = window.setInterval(() => {
                        remaining -= 1;
                        if (remaining <= 0) {
                            countdown.textContent = "now";
                            window.clearInterval(timer);
                            return;
                        }
                        countdown.textContent = formatCountdown(remaining);
                    }, 1000);
                }
            }

            const fastReplyToggle = document.getElementById("fast-reply-toggle");
            const fastReplyPanel = document.getElementById("fast-reply-panel");
            const fastReplyClose = document.getElementById("fast-reply-close");
            const fastReplyForm = document.getElementById("fast-reply-form");
            const fastReplyContent = document.getElementById("fast-reply-content");
            const fastReplyPreview = document.getElementById("fast-reply-preview");
            const mainReplyContent = document.getElementById("content");

            const escapeHtml = (value) => {
                return value
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\"/g, "&quot;")
                    .replace(/'/g, "&#39;");
            };

            const renderMarkdownPreview = (value) => {
                if (!fastReplyPreview) {
                    return;
                }
                if (!value.trim()) {
                    fastReplyPreview.textContent = "Preview will appear here.";
                    return;
                }
                let output = escapeHtml(value);
                const codeTokens = [];
                output = output.replace(/`([^`]+)`/g, (_, code) => {
                    const token = `__CODE_${codeTokens.length}__`;
                    codeTokens.push(code);
                    return token;
                });
                output = output.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
                });
                output = output.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
                output = output.replace(/\*([^*]+)\*/g, "<em>$1</em>");
                output = output
                    .split("\n")
                    .map(line => {
                        if (line.startsWith("&gt;")) {
                            return `<blockquote>${line.replace(/^&gt;\s?/, "")}</blockquote>`;
                        }
                        return line;
                    })
                    .join("\n");
                output = output.replace(/\n/g, "<br>");
                output = output.replace(/__CODE_(\d+)__/g, (_, index) => {
                    const code = codeTokens[Number(index)] || "";
                    return `<code>${code}</code>`;
                });
                output = output.replace(cardNamePattern, (_, name) => createCardMarkup(name));
                fastReplyPreview.innerHTML = output;
                initCardTooltips();
            };

            const closeFastReply = () => {
                if (!fastReplyPanel || !fastReplyToggle) {
                    return;
                }
                fastReplyPanel.classList.remove("is-open");
                fastReplyPanel.setAttribute("aria-hidden", "true");
                fastReplyToggle.setAttribute("aria-expanded", "false");
                fastReplyToggle.style.display = "";
            };

            const openFastReply = () => {
                if (!fastReplyPanel || !fastReplyToggle) {
                    return;
                }
                fastReplyPanel.classList.add("is-open");
                fastReplyPanel.setAttribute("aria-hidden", "false");
                fastReplyToggle.setAttribute("aria-expanded", "true");
                fastReplyToggle.style.display = "none";
                if (fastReplyContent && mainReplyContent && !fastReplyContent.value) {
                    fastReplyContent.value = mainReplyContent.value;
                }
                renderMarkdownPreview(fastReplyContent?.value || "");
                fastReplyContent?.focus();
            };

            if (fastReplyToggle && fastReplyPanel && fastReplyContent) {
                fastReplyToggle.addEventListener("click", openFastReply);
                fastReplyClose?.addEventListener("click", closeFastReply);
                fastReplyContent.addEventListener("input", () => {
                    renderMarkdownPreview(fastReplyContent.value);
                });
                document.addEventListener("keydown", (event) => {
                    if (event.key === "Escape" && fastReplyPanel.classList.contains("is-open")) {
                        closeFastReply();
                    }
                });
                fastReplyForm?.addEventListener("submit", () => {
                    closeFastReply();
                });
            }
        });
    </script>
</body>
</html>
